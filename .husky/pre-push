#!/usr/bin/env sh

echo "üöÄ Pre-push checks for monorepo..."

# Get current branch name
CURRENT_BRANCH=$(git branch --show-current)

# Determine comparison base
if git ls-remote --heads origin "$CURRENT_BRANCH" | grep -q "$CURRENT_BRANCH"; then
  BASE="origin/$CURRENT_BRANCH"
else
  BASE="origin/main"
fi

echo "üìä Comparing with $BASE..."

# Check if any packages or app have changes
CHANGED_FILES=$(git diff --name-only "$BASE"...HEAD)
HAS_APP_CHANGES=$(echo "$CHANGED_FILES" | grep -q "^apps/" && echo "true" || echo "false")
HAS_PACKAGE_CHANGES=$(echo "$CHANGED_FILES" | grep -q "^packages/" && echo "true" || echo "false")

echo "üìÅ Changes detected:"
[ "$HAS_APP_CHANGES" = "true" ] && echo "  ‚úì Apps modified"
[ "$HAS_PACKAGE_CHANGES" = "true" ] && echo "  ‚úì Packages modified"

# Run checks efficiently with Turborepo
if [ "$HAS_APP_CHANGES" = "true" ] || [ "$HAS_PACKAGE_CHANGES" = "true" ]; then
  echo ""
  echo "üîç Running type checks..."
  npm run type-check
  
  if [ $? -ne 0 ]; then
    echo "‚ùå TypeScript errors found. Please fix them before pushing."
    exit 1
  fi
  
  echo "üß™ Running tests for affected packages..."
  npm run test:ci
  
  if [ $? -ne 0 ]; then
    echo "‚ùå Tests failed. Please fix them before pushing."
    exit 1
  fi
  
  echo "‚úÖ All pre-push checks passed!"
else
  echo "‚ÑπÔ∏è  No significant changes detected, skipping checks"
fi 